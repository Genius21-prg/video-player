<link rel='import' href='../../polymer/polymer-element.html'>
<link rel='import' href='../../polymer/lib/elements/dom-repeat.html'>
<link rel='import' href='3rd-imports/mobx.html'>
<link rel='import' href='3rd-imports/font-awesome.html'>

<link rel='import' href='services/state-manager.html'>
<link rel='import' href='components/video-stream.html'>
<link rel='import' href='components/control-bar/user-controls.html'>

<dom-module id='video-player'>
  <template>
    <style type="text/css">
      :host {
        display: inline-block;
      }
      /* For some reason, just chaining those fullscreen selectors into one big
         selector doesn't work so we're stupid-duplicating all the rules. */
      #video-player-container:-webkit-full-screen #streams-container{
        display: flex;
        align-items: center;
      }
      #video-player-container:-moz-full-screen #streams-container{
        display: flex;
        align-items: center;
      }
      #video-player-container:-ms-fullscreen #streams-container{
        display: flex;
        align-items: center;
      }
    </style>

    <div id='video-player-container'>
      <div id='streams-container'>
        <template is='dom-repeat' items='{{streams}}'>
          <video-stream state-manager='{{stateManager}}' url='{{item}}' master='{{equals(index, 0)}}'></video-stream>
        </template>
      </div>
      <user-controls state-manager='{{stateManager}}'></user-controls>
    </div>

  </template>

  <script>
    (function() {
      const {reaction} = mobx;

      class VideoPlayer extends Polymer.Element {
        static get is() { return 'video-player'; }

        static get properties() {
          return {
            streams: {
              type: Array,
              value: []
            },
            stateManager: {
              type: Object,
              readOnly: true,
              value: new StateManager(),
              observer: '_updateStateBindings'
            },
            configuration: {
              type: Array,
              value: function () { return []; } // Default value
            }
          };
        }

        ready() {
          super.ready();
          // When possible, use afterNextRender to defer non-critical
          // work until after first paint.
          Polymer.RenderStatus.afterNextRender(this, function() {
            // configure state manager based on input configuration
            this.streams = this.configuration.streams;
            this.stateManager.playState = this.configuration.playState;
            this.stateManager.seek(this.configuration.startPosition);
            this.stateManager.setVolume(this.configuration.volume);
            this.stateManager.playbackRate = this.configuration.playbackRate;
          });

          let videoPlayerInstance = this;

          this.$['video-player-container'].addEventListener('fullscreenchange', function(event) {
            // videoPlayerInstance.stateManager.toggleFullScreen();
          });
          this.$['video-player-container'].addEventListener('webkitfullscreenchange', function(event) {
            // videoPlayerInstance.stateManager.toggleFullScreen();
          });
          this.$['video-player-container'].addEventListener('mozfullscreenchange', function(event) {
            // videoPlayerInstance.stateManager.toggleFullScreen();
          });
          this.$['video-player-container'].addEventListener('msfullscreenchange', function(event) {
            // videoPlayerInstance.stateManager.toggleFullScreen();
          });

        }

        _updateStateBindings(){
          // Dispose old reactions
          if(this.reactionDisposers) {
            this.reactionDisposers.forEach(disposer => disposer());
          }
          // Register new reactions
          this.reactionDisposers = [
            reaction(() => this.stateManager.fullScreen, this._fullScreenChanged.bind(this))
          ];
        };

        _fullScreenChanged(fullScreen) {
          if (fullScreen) {
            if (this.$['video-player-container'].requestFullscreen) this.$['video-player-container'].requestFullscreen();
            else if (this.$['video-player-container'].mozRequestFullScreen) this.$['video-player-container'].mozRequestFullScreen();
            else if (this.$['video-player-container'].webkitRequestFullScreen) this.$['video-player-container'].webkitRequestFullScreen();
            else if (this.$['video-player-container'].msRequestFullscreen) this.$['video-player-container'].msRequestFullscreen();
          } else {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
            else if (document.webkitCancelFullScreen) document.webkitCancelFullScreen();
            else if (document.msExitFullscreen) document.msExitFullscreen();
          }
        }

        equals(a, b) {
          return a === b;
        }
      }

      window.customElements.define(VideoPlayer.is, VideoPlayer);
    })();
  </script>
</dom-module>
