<link rel="import" href="../constants.html">
<link rel="import" href="state-manager.html">

<script>
  define('analytics-manager', ['constants'], (constants) => {
    const {ANALYTICS_TOPICS} = constants;

    class AnalyticsManager {
      /**
       * Initializes a new AnalyticsManager instance.
       * @param {VideoPlayer} videoPlayer  The VideoPlayer that dispatches the events.
       * @return {AnalyticsManager}  The new AnalyticsManager instance.
       */
      constructor(videoPlayer, stateManager) {
        this.videoPlayer = videoPlayer;
        this.stateManager = stateManager;
      }

      /**
       * Changes the given state, tracks the change and fire an analytics event.
       * @param {string} changeFunction The name of ste StateManager's methos to be executed
       * @param {Object} changeParameters An Array of parameters for the changeFunction
       * @param {Object} options Further options for tracking the state change
       */
      changeState(changeFunction, changeParameters, options) {
        let eventData = {
          detail: Object.assign(
            this._getBaseEventData(),
            {
              verb: options.verb,
              old_current_time: this.stateManager.state.position,
            }),
        };

        this.stateManager[changeFunction](...changeParameters);
        eventData.detail.new_current_time = this.stateManager.state.position;
        let event = new CustomEvent('analytics', eventData);
        this.videoPlayer.dispatchEvent(event);
      }

      /**
       * Gets the minimum set of information for events
       * @return {Object} Object containing the minimum set of information for events
       */
      _getBaseEventData() {
        return {
          current_time: this.stateManager.state.position,
          current_speed: this.stateManager.state.playbackRate,
          current_quality: this.stateManager.state.quality,
          current_source: 'online',
          current_orientation: window.screen.orientation.type,
          current_slide: this._getActiveSlide(),
          current_chapter: this._getActiveChapter(),
          current_fullscreen: this.stateManager.state.fullscreen == true,
        };
      }

      /**
       * Gets the active chapter
       * @return {Object} The active chapter object, undefined if there are no chapters
       */
      _getActiveChapter() {
        if (this.videoPlayer._hasChapters) {
          let chapters = this.videoPlayer.configuration.chapters;
          return chapters.slice()
                          .reverse()
                          .find(chapter => chapter.seconds <= this.stateManager.state.position);
        }
        else
          return undefined;
      }

      /**
       * Gets the active slide
       * @return {Object} The active slide object, undefined if there are none
       */
      _getActiveSlide() {
        if (this.videoPlayer.configuration.lectureSlides) {
          let slides = this.videoPlayer.configuration.lectureSlides;
          return slides.slice()
                          .reverse()
                          .find(slide => slide.startPosition <= this.stateManager.state.position);
        }
        else
          return undefined;
      }
    }

    return AnalyticsManager;
  });
</script>
