<link rel="import" href="../constants.html">
<link rel="import" href="state-manager.html">

<script>
  define('analytics-manager', ['constants'], (constants) => {
    const {ANALYTICS_TOPICS} = constants;

    class AnalyticsManager {
      /**
       * Initializes a new AnalyticsManager instance.
       * @param {VideoPlayer} videoPlayer  The VideoPlayer that dispatches the events.
       * @return {AnalyticsManager}  The new AnalyticsManager instance.
       */
      constructor(videoPlayer, stateManager) {
        this.videoPlayer = videoPlayer;
        this.stateManager = stateManager;
      }

      // TODO: get ref to statemanager function with parameters an call it, then fire event
      fireEvent() {
        var event = new CustomEvent('analytics', { 'detail': 'whooooho'});
        this.videoPlayer.dispatchEvent(event);
      }

      changeState(changeFunction, changeParameters, options) {
        let eventData = {
          detail: Object.assign(
            this._getBaseEventData(),
            {
              verb: options.verb,
              old_current_time: this.stateManager.state.position,
            }),
        };

        this.stateManager[changeFunction](...changeParameters);
        eventData.detail.new_current_time = this.stateManager.state.position;
        let event = new CustomEvent('analytics', eventData);
        this.videoPlayer.dispatchEvent(event);
      }

      _getBaseEventData() {
        return {
          current_time: this.stateManager.state.position,
          current_speed: this.stateManager.state.playbackRate,
          current_quality: this.stateManager.state.quality,
          current_source: 'online',
          current_orientation: 'landscape',
          current_slide: 0,
          current_chapter: 0,
        };
      }

    }

    return AnalyticsManager;
  });
</script>
