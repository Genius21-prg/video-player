<script>
  const {extendObservable} = mobx;

  class StateManager {
    constructor() {
      extendObservable(this, {
        playState: 'PAUSED',
        position: 0,
        playbackRate: 1.0,
        volume: 1,
        muted: false,
        duration: 0,
        fullScreen: false
      })
    }

    static get PLAYBACK_RATES() {
      return [0.7, 1.0, 1.3, 1.5, 1.8, 2.0];
    }

    play() {
      this.playState = 'PLAYING';
    }

    pause() {
      this.playState = 'PAUSED';
    }

    togglePlayPause() {
      if(this.playState == 'PLAYING') {
        this.pause()
      } else {
        this.play();
      }
    }

    seek(seconds) {
      this.position = seconds;
    }

    setPlaybackRate(playbackRate) {
      this.playbackRate = playbackRate;
    }
    
    switchPlaybackRate() {
      let newIndex = (StateManager.PLAYBACK_RATES.indexOf(this.playbackRate) + 1) % StateManager.PLAYBACK_RATES.length;
      this.setPlaybackRate(StateManager.PLAYBACK_RATES[newIndex]);
    }

    toggleMute() {
      if(this.muted) {
        this.unmute()
      } else {
        this.mute();
      }
    }

    mute() {
        this.muted = true;
    }

    unmute() {
        this.muted = false;
    }

    toggleFullScreen() {
      // This shit don't work right. When the user exits full screen mode
      // with the 'Esc' button, we can detect it only separately from the keyboard 
      // event right now. Therefore, we don't know how to handle this properly.
      // Workaround: Just do a toggle and risk confusing the user a little.
      // let newFullScreenValue = !(document.fullScreen || document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement || document.fullscreenElement);
      // if(newFullScreenValue !== this.fullScreen) {
        this.fullScreen = !this.fullScreen;
      // }
    }

    enterFullScreen() {
      this.fullScreen = true;
    }

    exitFullScreen() {
      this.fullScreen = false;
    }

    setVolume(volume) {
      // always unmute first to avoid potential inconsistent states between e.g. mute button icon and sound-control-bar
      this.unmute();
      if(volume >= 0 || volume <= 100) {
        this.volume = volume;
      }
    }

    setDuration(duration) {
      this.duration=duration;
    }
  }
</script>
