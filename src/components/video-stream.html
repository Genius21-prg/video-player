<link rel="import" href="../../bower_components/imd/imd.html">

<link rel="import" href="../base-element.html">
<!--link rel="import" href="track-element.html"-->

<dom-module id="video-stream">
  <template>
    <style type="text/css">
      #container__video_stream {
        width: 100%;
        height: 100%;
      }
      video {
        width: inherit;
        height: inherit;
      }
    </style>

    <div id="container__video_stream">
      <video
        id="video"
        src$="[[url]]"
        preload="auto"
        on-click="handleClick"
        on-loadedmetadata="handleLoadedMetadata"
        on-timeupdate="handleTimeUpdate">
        <template is="dom-repeat" items="{{captions}}">
          <track src="[[item.source]]" kind="subtitles" srclang="[[item.language]]" label="English">
        </template>  
      </video>
    </div>
  </template>

  <script>
    define('video-stream', ['base-element'], (BaseElement) => {
      class VideoStream extends BaseElement {
        static get is() { return 'video-stream'; }

        static get properties() {
          return {
            state: Object,
            stateManager: Object,
            url: String,
            mode: String,
            captions: {
              type: Object,
              value: () => ({})
            },
            master: {
              type: Boolean,
              value: true,
            },
          };
        }

        static get observers() {
          return [
            'playStateChanged(state.playState)',
            'positionChanged(state.position)',
            'playbackRateChanged(state.playbackRate)',
            'volumeChanged(state.volume)',
            'mutedChanged(state.muted)',
            'captionsToggled(state.showCaptions)'
          ];
        }
        handleTimeUpdate() {
          if(this.master) {
            this.stateManager.setPosition(this.$.video.currentTime);
          }
        }

        handleLoadedMetadata() {
          // Extract duration of the video after metadata have been loaded
          if(this.master) {
            this.stateManager.setDuration(this.$.video.duration);
          }
        }

        handleClick() {
          this.stateManager.togglePlayPause();
        }

        playStateChanged(playState) {
          if (playState === 'PLAYING')
            this.$.video.play();
          else
            this.$.video.pause();
        }

        positionChanged(position) {
          if( Math.abs(this.$.video.currentTime - position) > 1 ) {
            this.$.video.currentTime = position;
          }
        }

        playbackRateChanged(playbackRate) {
          this.$.video.playbackRate = playbackRate;
        }

        volumeChanged(volume) {
          this.$.video.volume = volume;
        }

        mutedChanged(muted) {
          this.$.video.muted = muted;
        }

        captionsToggled(captions) {
          Polymer.RenderStatus.afterNextRender(this, function() {
            if(this.master){
              this.state.showCaptions ? this.$.video.textTracks[0].mode = "showing" : this.$.video.textTracks[0].mode = "hidden";
            }
          });
        }
      }

      window.customElements.define(VideoStream.is, VideoStream);
    });
  </script>

</dom-module>
