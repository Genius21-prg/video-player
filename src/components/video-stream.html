<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../constants.html">
<link rel="import" href="../3rd-imports/hls-js.html">

<dom-module id="video-stream">

  <template>
    <style type="text/css">
      #container__video_stream {
        width: 100%;
        height: 100%;
      }
      video {
        width: inherit;
        height: inherit;
      }
    </style>

    <div id="container__video_stream">
      <video id="video" preload="auto"></video>
    </div>
  </template>

  <script>
    define(['constants', 'hls-js'], (constants, Hls) => {
      const {PLAY_STATES, QUALITY_MODES, SYNC_DIFF_THRESHOLD} = constants;

      class VideoStream extends Polymer.Element {
        static get is() { return 'video-stream'; }

        static get properties() {
          return {
            state: Object,
            stateManager: Object,
            urls: Object,
            master: {
              type: Boolean,
              value: true,
            },
            qualityUrl: String,
            initializingVideo: {
              type: Boolean,
              value: true,
            },
            hlsClient: Object,
          };
        }

        static get observers() {
          return [
            '_playStateChanged(state.playState)',
            '_positionChanged(state.position)',
            '_playbackRateChanged(state.playbackRate)',
            '_volumeChanged(state.volume)',
            '_mutedChanged(state.muted)',
            '_qualityChanged(urls, state.quality)',
          ];
        }

        ready() {
          super.ready();

          // Update position on state, if stream is master
          this.$.video.addEventListener('timeupdate', () => {
            if(this.master && !this.initializingVideo) {
              this.stateManager.setPosition(this.$.video.currentTime);
            }
          });

          // Update duration on state from metadata, if stream is master
          this.$.video.addEventListener('loadedmetadata', () => {
            if(this.master) {
              this.stateManager.setDuration(this.$.video.duration);
            }
          });

          // When changing the source of the HTML5 video player, its state is resetted.
          // Therefore, the current state is applied manually after initialization of the video.
          this.$.video.addEventListener('canplay', () => {
            if(this.initializingVideo) {
              this._applyState();
              this.initializingVideo = false;
            }
          });

          // Start/stop playback when the stream is clicked
          this.$.video.addEventListener('click', () => this.stateManager.togglePlayPause());
        }

        _applyState() {
          this._playStateChanged(this.state.playState);
          this._positionChanged(this.state.position);
          this._playbackRateChanged(this.state.playbackRate);
          this._volumeChanged(this.state.volume);
          this._mutedChanged(this.state.muted);
        }

        _playStateChanged(playState) {
          if (playState === PLAY_STATES.PLAYING)
            this.$.video.play();
          else
            this.$.video.pause();
        }

        _positionChanged(position) {
          if(Math.abs(this.$.video.currentTime - position) > SYNC_DIFF_THRESHOLD) {
            this.$.video.currentTime = position;
          }
        }

        _playbackRateChanged(playbackRate) {
          this.$.video.playbackRate = playbackRate;
        }

        _volumeChanged(volume) {
          this.$.video.volume = volume;
        }

        _mutedChanged(muted) {
          this.$.video.muted = muted;
        }

        _qualityChanged(urls, quality) {
          let url = urls[quality];
          this.initializingVideo = true;

          // Change source depending on quality
          if(quality !== QUALITY_MODES.HLS) {
            // Destroy old hls client
            if(this.hlsClient) {
              this.hlsClient.destroy();
            }

            // The src attribute can not be updated using data bindings
            // since the binding may be overwritten by hls.js
            this.$.video.setAttribute('src', url);
          } else {
            // Create and configure new hls client for existing video element
            this.hlsClient = new Hls();
            this.hlsClient.loadSource(url);
            this.hlsClient.attachMedia(this.$.video);
          }
        }
      }

      window.customElements.define(VideoStream.is, VideoStream);
    });
  </script>

</dom-module>
