<link rel="import" href="../../../bower_components/imd/imd.html">

<link rel="import" href="../../base-element.html">
<link rel="import" href="../styling/control-bar--style-module.html">

<dom-module id="select-control">

  <template>
    <style type="text/css" include="control-bar--style-module">
      .dropdown {
        position: relative;
      }
      .dropdown-content {
        position: absolute;
        /* Equals control bar height. This is set to assure that the dropdown opens to the top. */
        bottom: 45px;
        /* Cancel out the padding */ 
        left: -10px;

        background-color: #424242;
        background-color: var(--background-color-for-primary);
        color: #FFFFFF;
        color: var(--primary-color);
      }
      .dropdown-content a {
        line-height: 2;
        padding: 7px 10px;
        cursor: pointer;
      }      
      .dropdown-content a:hover {
        background-color: grey;
      }     
      .dropdown-content a.selected {
        background-color: grey;
      }
    </style>

    <div id="container__select_control" class="user_controls">
      <!-- Show control as binary switch if there are only 2 values to choose from. -->
      <template is="dom-if" if="{{binarySelection}}">
        <a id="button__select" class="button" on-click="handleBinaryButtonClick">
          [[formatter(selectedValue)]]
        </a>
      </template>

      <!-- Show control as dropdown if there are more than 2 values to choose from. -->
      <template is="dom-if" if="{{!binarySelection}}">
        <div class="dropdown">
          <a id="button__select" class="button" on-click="handleMultipleButtonClick">
            [[formatter(selectedValue)]]
          </a>
          <div id="dropdown__select" class="dropdown-content" style$="display: [[ifThenElse(isDropDownOpen, 'initial;', 'none;')]]"> 
            <template is="dom-repeat" items="[[values]]">
              <a on-click="handleSelectionChanged" class$="[[ifEqualsThen(item, selectedValue, 'selected')]]">[[formatter(item)]]</a>
            </template>
          </div>
        </div>
      </template>
    </div>
  </template>

  <script>
    define('select-control', ['base-element'], (BaseElement) => {
      class SelectControl extends BaseElement {
        static get is() { return 'select-control'; }

        static get properties() {
          return {
            values: {
              type: Array,
              value: [],
            },
            selectedValue: String,
            formatter: {
              type: Function,
              value: (x) => x,
            },
            binarySelection: {
              type: Boolean,
              computed: '_binarySelection(values)',
            },
            isDropDownOpen: {
              type: Boolean,
              value: false
            }
          };
        }

        _binarySelection() {
          return this.values && this.values.length === 2;
        }

        handleBinaryButtonClick() {
          let index = (this.values.indexOf(this.selectedValue) + 1) % this.selectedValue.length;
          this.setSelectedValue(this.values[index]);
        }

        handleMultipleButtonClick() {
          this.isDropDownOpen = !this.isDropDownOpen;
        }

        handleSelectionChanged(e) {
          this.setSelectedValue(e.model.item);
          this.isDropDownOpen = false;
        }

        setSelectedValue(value) {
          this.selectedValue = value;
          this.dispatchEvent(new CustomEvent('change'));
        } 
      }

      window.customElements.define(SelectControl.is, SelectControl);
    });
  </script>

</dom-module>
