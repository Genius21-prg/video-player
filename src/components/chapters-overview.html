<link rel='import' href='../../../polymer/polymer-element.html'>
<link rel='import' href='../3rd-imports/mobx.html'>
<link rel='import' href='styling/control-bar--style-module.html'>

<dom-module id='chapters-overview'>
  <template>
    <style type='text/css' include='control-bar--style-module'> 
      .active {
        font-weight: bold;
      }
    </style>

    <div id='container__chapters_overview' class='_user_controls'>
      <ul>
          <template is='dom-repeat' items='{{outline.outlines}}'>
            <li><a on-click='handleClick' class="link__chapter_bookmark" data-time$='{{getTotalSeconds(item.title.time)}}'>{{item.title.text}}</a></li>
          </template>
      </ul>
    </div>
    </template>

  <script>
    (function() {
      const {reaction} = mobx;

      class ChaptersOverview extends Polymer.Element {
        static get is() { return 'chapters-overview'; }

        static get properties() {
          return {
            outline: {
                type: Object,
                value: {
                    outlines: []
                }
            },
            stateManager: {
              type: Object,
              observer: '_updateStateBindings'
            }
          };
        }

        ready() {
          super.ready();
          Polymer.RenderStatus.afterNextRender(this, function() {
            this.highlightChapter(this.stateManager.position);
          });
        }

        getTotalSeconds(time) {
          let splitTime = time.split(':');
          return parseInt(splitTime[0]) * 3600 + parseInt(splitTime[1]) * 60 + parseInt(splitTime[2]);
        }

        handleClick(e) {
          let time = parseInt(e.path[0].attributes.getNamedItem('data-time').value);
          
          this.stateManager.seek(time);
          this.highlightChapter(time);
        }

        _updateStateBindings() {
          // Dispose old reactions
          if(this.reactionDisposers) {
            this.reactionDisposers.forEach(disposer => disposer());
          }
          // Register new reactions
          this.reactionDisposers = [
            reaction(() => this.stateManager.position, this._positionChanged.bind(this))
          ];
        }

        _positionChanged(position) {
          this.highlightChapter(position);
        }

        highlightChapter(position) {
          if (this.shadowRoot.querySelector('.active')) {
            this.shadowRoot.querySelector('.active').classList.remove('active');
          }
          this.shadowRoot.querySelector('[data-time="' + this.closestChapterPosition(position) + '"]').classList.add('active');
        }

        closestChapterPosition(position) {
          let positions = this.outline.outlines.map(function(chapter) {
            return this.getTotalSeconds(chapter.title.time);
          }, this);
          let closestPosition = positions[0];
          if (position > positions[0]) {
            for(let i = 1; i < positions.length; i++) {
              if (positions[i] > position) {
                break;
              }
              closestPosition = positions[i];
            }
          }
          return closestPosition;
        }
      }

      window.customElements.define(ChaptersOverview.is, ChaptersOverview);
    })();
  </script>

</dom-module>
