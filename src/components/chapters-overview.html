<link rel='import' href='../../../polymer/polymer-element.html'>
<link rel='import' href='styling/control-bar--style-module.html'>

<dom-module id='chapters-overview'>
  <template>
    <style type='text/css' include='control-bar--style-module'> 
      .active {
        font-weight: bold;
      }
    </style>

    <div id='container__chapters_overview' class='_user_controls'>
      <ul>
          <template is='dom-repeat' items='{{outline.outlines}}'>
            <li><a on-click='handleClick' class="link__chapter_bookmark" data-time$='{{getTotalSeconds(item.title.time)}}'>{{item.title.text}}</a></li>
          </template>
      </ul>
    </div>
    </template>

  <script>
    class ChaptersOverview extends Polymer.Element {
      static get is() { return 'chapters-overview'; }

      static get properties() {
        return {
          outline: {
              type: Object,
              value: {
                  outlines: []
              }
          },
          state: {
              type: Object
          },
          stateManager: {
            type: Object
          }
        };
      }

      static get observers() {
        return [
          '_positionChanged(state.position)'
        ];
      }

      ready() {
        super.ready();
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.highlightChapter(this.state.position);
        });
      }

      getTotalSeconds(time) {
        let splitTime = time.split(':');
        return parseInt(splitTime[0]) * 3600 + parseInt(splitTime[1]) * 60 + parseInt(splitTime[2]);
      }

      handleClick(e) {
        let time = parseInt(e.path[0].attributes.getNamedItem('data-time').value);
        
        this.stateManager.setPosition(time);
        this.highlightChapter(time);
      }

      _positionChanged(position) {
        this.highlightChapter(position);
      }

      highlightChapter(position) {
        let activeElement = this.shadowRoot.querySelector('.active');
        let highlightElement = this.shadowRoot.querySelector('[data-time="' + this.closestChapterPosition(position) + '"]');
        if (activeElement) {
          activeElement.classList.remove('active');
        }
        if (highlightElement) {
          highlightElement.classList.add('active');
        }
      }

      closestChapterPosition(position) {
        let positions = this.outline.outlines.map(function(chapter) {
          return this.getTotalSeconds(chapter.title.time);
        }, this);
        let closestPosition = positions[0];
        if (position > positions[0]) {
          for(let i = 1; i < positions.length; i++) {
            if (positions[i] > position) {
              break;
            }
            closestPosition = positions[i];
          }
        }
        return closestPosition;
      }
    }

    window.customElements.define(ChaptersOverview.is, ChaptersOverview);
  </script>

</dom-module>
