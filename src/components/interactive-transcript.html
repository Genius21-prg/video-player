<link rel="import" href="../../bower_components/imd/imd.html">

<link rel="import" href="../mixins/binding-helpers.html">
<link rel="import" href="../mixins/ioc-requester.html">
<link rel="import" href="../styling/lists--style-module.html">

<dom-module id="interactive-transcript">
  <link rel="import" type="css" href="../../bower_components/components-font-awesome/css/font-awesome.min.css">
  <template>
    <style type="text/css" include="lists--style-module">

      #container__interactive_transcript {
        overflow: hidden;
        color: black;
        height: 200px;
        width: 100%;
      }

      #container__interactive_transcript .list {
        perspective: 400px;
        perspective: 300px;
        perspective-origin: 50% 50%;
      }

      #container__interactive_transcript .list_item {
        display: flex;
        padding: 15px 5px 15px 20px;
        background-color: #eee;
        font-size: 1rem;
        @apply --transition-duration-600;
      }
      #container__interactive_transcript .list_item .list_item__prefix {
        white-space: nowrap;
        margin-right: 15px;
      }

      #container__interactive_transcript .list_item.-active,
      #container__interactive_transcript .list_item:nth-child(odd).-active {
        background-color: #999;
      }

      #container__interactive_transcript .list_item:nth-child(odd) {
        background-color: #fff;
      }

      #container__interactive_transcript .list_item:hover,
      #container__interactive_transcript .list_item.-active:hover {
        @apply --accent-color-background;
        @apply --transition-duration-200;
      }
    </style>

    <div id="container__interactive_transcript" class="container__list">
      <ul class="list">
          <template is="dom-repeat" items="{{cues}}">
            <li class$="list_item [[ifEqualsThen(item, activeTranscript, '-active')]]">
              <a class$="list_item__prefix list_item__link [[ifEqualsThen(item, activeTranscript, 'active fa-caret-right')]]" on-click="handleClick">
                [[secondsToHms(item.startTime, state.duration)]] - [[secondsToHms(item.endTime, state.duration)]]:
              </a>
              <a class="list_item__link" on-click="handleClick">
                {{item.text}}
              </a>
            </li>
          </template>
      </ul>
    </div>
  </template>

  <script>
    define('interactive-transcript', ['binding-helpers', 'ioc-requester'], (BindingHelpersMixin, IocRequesterMixin) => {
      class InteractiveTranscript extends BindingHelpersMixin(IocRequesterMixin(Polymer.Element)) {
        static get is() { return 'interactive-transcript'; }

        static get properties() {
          return {
            state: Object,
            stateManager: {
              type: Object,
              inject: 'StateManager',
            },
            cues: {
              type: Array,
              value: [],
            },
            activeTranscript: Object,
          };
        }

        static get observers() {
          return [
            'getCues(state.cues)',
            'updateActiveTranscript(cues, state.position)',
          ];
        }


        getCues(){
          // flush array
          this.splice("cues", 0, this.cues.length);
          // refill it
          if(this.state.cues) {
            for(let i = 0; i < this.state.cues.length; i++){
              this.push('cues', this.state.cues[i]);
            }
          }
          // call update ...because listener on 'cues' does not seem to work
          this.updateActiveTranscript();
        }

        handleClick(e) {
          let cuePoint = e.model.item;
          this.stateManager.setPosition(cuePoint.startTime);
        }

        updateActiveTranscript() {
          let oldTranscript = this.activeTranscript;
          this.activeTranscript = this.cues.slice()
                                            .reverse()
                                            .find(cuePoint => cuePoint.startTime <= this.state.position);
          this.scrollIntoView(oldTranscript, this.activeTranscript);
        }

        scrollIntoView(oldElement, newElement) {
          let activeElement = this.$.container__interactive_transcript.getElementsByClassName('-active')[0];
          if(activeElement && oldElement !== newElement) {
            activeElement.scrollIntoView({behavior: 'smooth'});
          }
        }
      }

      window.customElements.define(InteractiveTranscript.is, InteractiveTranscript);
    });
  </script>

</dom-module>
